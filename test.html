<html>
<head>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
<style>
	div { display: inline-block; margin-right: 20px; }
</style>
<script>
	$(document).ready(function() {
		var file = "/var/www/balloon.jp2";
		var workers = ["localhost"];
		var can = $("canvas")[0];
		var ctx = can.getContext('2d');
		var bufcan = $("#buf")[0];
		var buf = bufcan.getContext('2d');
		buf.strokeStyle = "#5555ff";

		function show(redux, data) {
			bufcan.width = can.width = parseInt($("input#width").val());
			bufcan.height = can.height = parseInt($("input#height").val());
			ctx.clearRect(0, 0, can.width, can.height);
			buf.clearRect(0, 0, can.width, can.height);
			function reduce(val, reduction) {
				if(reduction == 0) { return val; }
				return reduce(val / 2, --reduction);
			}

			var method = $("input[name='method']:checked").val();
			var loaded = 0;
			var timed = new Date().getTime();
			var th = reduce(data.tdy * data.th, redux) > can.height ? Math.ceil(can.height / reduce(data.tdy, redux)) : data.th;
			var tw = reduce(data.tdx * data.tw, redux) > can.width ? Math.ceil(can.width / reduce(data.tdx, redux)) : data.tw;
			var tiles = [];
			var pending = false;
			var currentWorker = 0;
			for(var y = 0; y < th; y++) {
				for(var x = 0; x < tw; x++) {
					var img = new Image();
					var tile = x + (y * data.tw);
					var imgX = reduce(x * data.tdx, redux);
					var imgY = reduce(y * data.tdy, redux);
					var w = reduce(data.tdx, redux);
					var h = reduce(data.tdy, redux);
					if((x+1) * w > can.width) { w = can.width - (x * w); }
					if((y+1) * h > can.height) { h = can.height - (y * h); }
					if(++currentWorker == workers.length) { currentWorker = 0; }
					var src = "http://" + workers[currentWorker] + "/cgi-bin/jp2?f=" + 
							file + 
							"&r=" + redux + 
							"&t=" + tile + 
							"&x=0" + 
							"&y=0" +
							"&w=" + w +
							"&h=" + h;

					if(method == "parallel") { img.src = src;} 
					else { 
						tiles.push({img: img, src: src});
						if(!pending) { 
							var tile = tiles.pop();
							tile.img.src = tile.src;
							pending = true;
						}
					}


					(function(x,y) {
						$(img).on("load", function() {
							if(tiles.length > 0) { 
								var tile = tiles.pop();
								tile.img.src = tile.src;
							}
							buf.drawImage(this, x, y);
							buf.beginPath();
							buf.moveTo(x, y);
							buf.lineTo(x, y + this.height);
							buf.moveTo(x, y + this.height);
							buf.lineTo(x + this.width, y + this.height);
							buf.stroke();

							$(".timed").html(Math.floor(loaded / (th * tw) * 100) + "%")
							if(++loaded == th * tw) {
								if(method == "sequential") {
									$(".timed").html("DONE - avg/tile: " + Math.floor((new Date().getTime() - timed) / loaded) + "ms");
								} else {
									$(".timed").html("DONE - total: " + (new Date().getTime() - timed) + "ms");
								}
								$("button").prop("disabled", false);
								ctx.drawImage(bufcan, 0, 0);
							}
						});
					}) (imgX, imgY);
				}
			}
		}


		$.ajax("/cgi-bin/jp2?f=" + file, {success: function(data) {
			var i = 0;

			for(var i = 0; i < data["num_res"]; i++) {
				(function(redux) {
					$(".zoom-levels").append($("<button>").html(i).on("click", function(e) {
						$("button").prop("disabled", true);
						show(redux, data);
					}));
				})(i);
			}
		}});
	});
</script> 
</head>

<body>
	Select method:
	<div>
		<input id="method-parallel" type="radio" name="method" value="parallel" checked />
		<label for="method-parallel">Parallel</label>
		<input id="method-sequential" type="radio" name="method" value="sequential" />
		<label for="method-sequential">Sequential</label>
	</div>
	Set canvas size:
	<div>
		<input id="width" value="1880" />x
		<input id="height" value="1000" />
	</div>

	Select reduction:
	<div class="zoom-levels"></div>
	<div class="timed"></div>
	<canvas width="1880" height="1000">
	</canvas>

	<canvas id="buf" style="display: none" width="1880" height="1000">
	</canvas>

</body>

</html>
